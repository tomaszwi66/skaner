<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skaner Faktur - Wersja Długopis</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 10px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; }
        video { width: 100%; border-radius: 12px; border: 2px solid #333; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 10px 0; }
        .btn-main { background: #007bff; color: white; }
        .btn-snap { background: #28a745; color: white; display: none; }
        #debug-zone { background: #000; padding: 10px; border-radius: 10px; border: 1px solid #444; margin-top: 10px; }
        canvas { width: 100%; border: 1px solid #666; image-rendering: pixelated; }
        #status { font-weight: bold; margin: 10px 0; color: #ffc107; }
        #raw-text { font-family: monospace; font-size: 12px; color: #00ff00; background: #222; padding: 10px; border-radius: 5px; min-height: 20px; word-break: break-all; }
        table { width: 100%; background: white; color: black; margin-top: 20px; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
    <script src="tesseract.min.js"></script>
</head>
<body>

<div class="container">
    <video id="video" autoplay playsinline></video>
    
    <button id="startBtn" class="btn btn-main">1. URUCHOM KAMERĘ</button>
    <button id="captureBtn" class="btn btn-snap">2. SKANUJ NUMER</button>

    <div id="status">Gotowy</div>

    <div id="debug-zone">
        <p style="font-size:10px; margin:0 0 5px 0;">PODGLĄD (Musi być widać długopis!):</p>
        <canvas id="outCanvas"></canvas>
        <div id="raw-text">Tu pojawi się odczyt...</div>
    </div>

    <table id="list"><tbody></tbody></table>
    <button id="downloadBtn" class="btn" style="background:#6c757d; color:white; display:none;">POBIERZ CSV</button>
</div>

<script>
    const video = document.getElementById('video');
    const outCanvas = document.getElementById('outCanvas');
    const status = document.getElementById('status');
    const rawTextEl = document.getElementById('raw-text');
    const outCtx = outCanvas.getContext('2d', { willReadFrequently: true });

    // 1. START KAMERY
    document.getElementById('startBtn').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'block';
            status.innerText = "Ustaw numer w centrum i kliknij Skanuj";
        } catch (e) { status.innerText = "Błąd: " + e.message; }
    };

    // 2. PRZETWARZANIE (Zoptymalizowane pod długopis)
    document.getElementById('captureBtn').onclick = async () => {
        status.innerText = "Przetwarzanie...";
        
        // Wycinamy środek
        const w = video.videoWidth;
        const h = video.videoHeight;
        const cropH = h * 0.25; // Pasek 25% wysokości
        
        outCanvas.width = w;
        outCanvas.height = cropH;
        
        // Rysujemy wycinek
        outCtx.drawImage(video, 0, h*0.37, w, cropH, 0, 0, w, cropH);

        // FILTR: Zamiast czarno-białego, robimy inteligentny kontrast
        const imgData = outCtx.getImageData(0, 0, w, cropH);
        const d = imgData.data;
        
        for (let i = 0; i < d.length; i += 4) {
            // Skala szarości
            let v = 0.2126 * d[i] + 0.7152 * d[i+1] + 0.0722 * d[i+2];
            
            // MOCNY KONTRAST (Adaptive-like)
            // Wyciągamy ciemne linie (długopis) i rozjaśniamy tło
            if (v < 130) { v = v * 0.5; } // Przyciemnij to co już ciemne (długopis)
            else { v = 255; } // Wybiel tło
            
            d[i] = d[i+1] = d[i+2] = v;
        }
        outCtx.putImageData(imgData, 0, 0);

        runOCR();
    };

    // 3. OCR
    async function runOCR() {
        status.innerText = "Robot czyta...";
        try {
            const worker = await Tesseract.createWorker('eng', 1, {
                workerPath: './worker.min.js',
                corePath: './tesseract-core.wasm.js',
                langPath: './',
                gzip: true
            });

            await worker.setParameters({
                tessedit_char_whitelist: '0123456789EKOUMW/|lI',
            });

            const { data: { text } } = await worker.recognize(outCanvas);
            rawTextEl.innerText = "Odczytano: " + text;

            // Sprzątanie tekstu pod wzorzec
            const clean = text.replace(/\s/g, '').toUpperCase();
            const match = clean.match(/(\d{4,})[\/|lI1]EK[0O][\/|lI1]UMW[\/|lI1]2025/);

            if (match) {
                const finalNr = match[1] + "/EKO/UMW/2025";
                save(finalNr);
                status.innerHTML = `<span style="color:#28a745">ZNALEZIONO: ${finalNr}</span>`;
            } else {
                status.innerText = "Nie znaleziono wzoru. Spróbuj zmienić kąt.";
            }
            await worker.terminate();
        } catch (e) { status.innerText = "Błąd OCR: " + e.message; }
    }

    function save(nr) {
        let list = JSON.parse(localStorage.getItem('faktury_final') || '[]');
        if(!list.includes(nr)) {
            list.push(nr);
            localStorage.setItem('faktury_final', JSON.stringify(list));
        }
        render();
    }

    function render() {
        const list = JSON.parse(localStorage.getItem('faktury_final') || '[]');
        const tbody = document.querySelector('#list tbody');
        tbody.innerHTML = list.map((item, idx) => `<tr><td>${item}</td></tr>`).join('');
        if(list.length > 0) document.getElementById('downloadBtn').style.display = 'block';
    }

    document.getElementById('downloadBtn').onclick = () => {
        const list = JSON.parse(localStorage.getItem('faktury_final') || '[]');
        const csv = "Numer Faktury\n" + list.join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
        a.download = 'faktury.csv';
        a.click();
    };

    render();
</script>
</body>
</html>
