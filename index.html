<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skaner Faktur V2</title>
    <style>
        body { font-family: sans-serif; background: #333; color: white; padding: 10px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Obszar kamery */
        .camera-box { position: relative; overflow: hidden; border-radius: 12px; border: 2px solid #555; background: black; }
        video { width: 100%; display: block; }
        
        /* Nak≈Çadka celownika */
        .overlay {
            position: absolute; top: 30%; left: 10%; right: 10%; height: 40%;
            border: 2px solid rgba(255, 255, 0, 0.5);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        .guide-text {
            position: absolute; top: 10px; width: 100%; text-align: center;
            color: yellow; text-shadow: 1px 1px 2px black; font-size: 14px;
        }

        /* Przyciski */
        .btn { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #f44336; color: white; }

        /* Status i Debug */
        #status { margin: 10px 0; padding: 10px; background: #444; border-radius: 5px; min-height: 20px; font-size: 14px; }
        .debug-container { margin-top: 10px; background: white; color: black; padding: 10px; border-radius: 8px; }
        canvas { max-width: 100%; height: auto; border: 1px solid red; } /* Czerwona ramka pokazuje co analizujemy */
        
        /* Tabela */
        table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #fff; color: #000; border-radius: 8px; overflow: hidden; }
        td, th { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
    <script src="tesseract.min.js"></script>
</head>
<body>

<div class="container">
    <h3>Skaner Faktur V2</h3>
    
    <div class="camera-box">
        <video id="video" autoplay playsinline></video>
        <div class="overlay"></div>
        <div class="guide-text">Umie≈õƒá numer w ≈º√≥≈Çtej ramce<br>259405/EKO/UMW/2025</div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <button id="actionBtn" class="btn btn-blue">üì∑ Uruchom kamerƒô</button>

    <div id="status">Czekam na uruchomienie...</div>

    <div class="debug-container">
        <p style="margin:0; font-size:12px; color:gray;">CO WIDZI ROBOT (sprawd≈∫ czy czytelne):</p>
        <canvas id="debugCanvas"></canvas>
        <p id="rawText" style="font-family: monospace; font-size: 11px; word-break: break-all; margin-top:5px;"></p>
    </div>

    <table id="invoiceTable">
        <thead>
            <tr style="background:#eee"><th>Numer</th><th>X</th></tr>
        </thead>
        <tbody id="invoiceBody"></tbody>
    </table>
    
    <button id="downloadBtn" class="btn btn-green" style="display:none;">üíæ Pobierz CSV</button>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const debugCanvas = document.getElementById('debugCanvas');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('actionBtn');
    const rawTextEl = document.getElementById('rawText');
    let stream = null;
    let isCameraOn = false;

    // === 1. KAMERA I PRZYCISKI ===
    btn.addEventListener('click', async () => {
        if (!isCameraOn) {
            // W≈ÇƒÖczanie
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                video.srcObject = stream;
                isCameraOn = true;
                btn.textContent = "üì∏ ZR√ìB ZDJƒòCIE";
                btn.className = "btn btn-green";
                statusEl.textContent = "Wyceluj i zr√≥b zdjƒôcie";
            } catch (e) {
                statusEl.textContent = "B≈ÇƒÖd kamery: " + e.message;
            }
        } else {
            // Robienie zdjƒôcia
            captureAndProcess();
        }
    });

    // === 2. PRZETWARZANIE OBRAZU (Nowe podej≈õcie) ===
    function captureAndProcess() {
        // 1. Zrzut ca≈Çej klatki
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // 2. WYCINANIE (Crop) - Bierzemy tylko ≈õrodek (tam gdzie ≈º√≥≈Çta ramka)
        // Zak≈Çadamy, ≈ºe ramka to ≈õrodkowe 40% wysoko≈õci
        const sourceX = 0;
        const sourceY = canvas.height * 0.30; // Zaczynamy od 30% wysoko≈õci
        const sourceW = canvas.width;
        const sourceH = canvas.height * 0.40; // Bierzemy 40% wysoko≈õci

        // Ustawiamy p≈Ç√≥tno podglƒÖdu (debug) na rozmiar wycinka
        debugCanvas.width = sourceW;
        debugCanvas.height = sourceH;
        const dCtx = debugCanvas.getContext('2d');

        // Rysujemy wycinek
        dCtx.drawImage(canvas, sourceX, sourceY, sourceW, sourceH, 0, 0, sourceW, sourceH);

        // 3. FILTRY (Skala szaro≈õci + Kontrast) - ≈Åagodniejsze ni≈º wcze≈õniej
        const imgData = dCtx.getImageData(0, 0, sourceW, sourceH);
        const data = imgData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            // Konwersja na szaro≈õƒá (standardowa metoda luminancji)
            let gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            
            // Zwiƒôkszenie kontrastu (prosty algorytm)
            // Je≈õli ciemne -> jeszcze ciemniejsze. Je≈õli jasne -> ja≈õniejsze.
            gray = (gray - 128) * 1.5 + 128; 

            // Ograniczenie do 0-255
            if (gray < 0) gray = 0;
            if (gray > 255) gray = 255;

            data[i] = data[i+1] = data[i+2] = gray;
        }
        dCtx.putImageData(imgData, 0, 0);

        // Zatrzymujemy kamerƒô na chwilƒô (efekt 'zamro≈ºenia')
        video.pause();
        runOCR();
    }

    // === 3. OCR (M√≥zg) ===
    async function runOCR() {
        statusEl.textContent = "‚è≥ Analizujƒô cyferki...";
        rawTextEl.textContent = "Czytanie...";
        btn.disabled = true;

        try {
            const worker = await Tesseract.createWorker('eng', 1, {
                workerPath: './worker.min.js',
                corePath: './tesseract-core.wasm.js',
                langPath: './',
                gzip: true
            });

            // Pozwalamy na znaki alfanumeryczne (bez spacji i kropek w whitelist, ≈ºeby nie ≈õmieci≈Ç)
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789EKOUMW', // Tylko to nas interesuje
            });

            // Czytamy z debugCanvas (tego czarno-bia≈Çego paska)
            const { data: { text } } = await worker.recognize(debugCanvas);
            
            console.log("RAW:", text);
            
            // Czy≈õcimy wszystko co nie jest literƒÖ lub cyfrƒÖ
            // Np. "259 405 / E K O" zamieni siƒô na "259405EKO"
            const clean = text.replace(/[^A-Z0-9]/g, '');
            rawTextEl.textContent = "Widzƒô surowe: " + clean;

            // SZUKAMY WZORCA
            // Szukamy: Cyfry (4 do 8 sztuk) + EK + (O lub 0) + UMW + 2025
            const match = clean.match(/(\d{4,8})EK[O0]UMW2025/);

            if (match) {
                const number = match[1]; // To jest ta grupa (\d{4,8})
                const fullInvoice = `${number}/EKO/UMW/2025`;
                
                addInvoice(fullInvoice);
                statusEl.innerHTML = `<span style="color:#4CAF50; font-weight:bold;">‚úÖ MAMY TO: ${number}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:#f44336">‚ùå Nie rozpoznano wzorca.</span>`;
            }

            await worker.terminate();

        } catch (e) {
            statusEl.textContent = "B≈ÇƒÖd: " + e.message;
        }

        // Reset przycisku
        btn.disabled = false;
        btn.textContent = "üîÑ Skanuj ponownie";
        btn.className = "btn btn-blue";
        btn.onclick = () => {
            video.play();
            btn.onclick = null; // Usuwamy ten handler
            // Przywracamy standardowe dzia≈Çanie przycisku (zrobienie zdjƒôcia)
            btn.textContent = "üì∏ ZR√ìB ZDJƒòCIE";
            btn.className = "btn btn-green";
        };
    }

    // === 4. TABELA I ZAPIS ===
    function getInvoices() { return JSON.parse(localStorage.getItem('faktury_v2') || '[]'); }
    
    function addInvoice(inv) {
        const list = getInvoices();
        // Unikamy duplikat√≥w
        if(!list.includes(inv)) {
            list.push(inv);
            localStorage.setItem('faktury_v2', JSON.stringify(list));
            renderTable();
        } else {
             statusEl.innerHTML += " (Duplikat)";
        }
    }

    function removeInvoice(index) {
        const list = getInvoices();
        list.splice(index, 1);
        localStorage.setItem('faktury_v2', JSON.stringify(list));
        renderTable();
    }

    function renderTable() {
        const list = getInvoices();
        const tbody = document.getElementById('invoiceBody');
        tbody.innerHTML = '';
        list.slice().reverse().forEach((inv, idx) => {
            const realIdx = list.length - 1 - idx;
            tbody.innerHTML += `<tr>
                <td>${inv}</td>
                <td onclick="removeInvoice(${realIdx})" style="color:red; font-weight:bold; cursor:pointer;">X</td>
            </tr>`;
        });
        
        const downBtn = document.getElementById('downloadBtn');
        if(list.length > 0) {
            downBtn.style.display = 'block';
            downBtn.onclick = () => {
                const csv = "Numer Faktury\n" + list.join("\n");
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
                a.download = 'faktury.csv';
                document.body.appendChild(a);
                a.click();
            }
        } else {
            downBtn.style.display = 'none';
        }
    }

    renderTable();
</script>

</body>
</html>
