<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skaner Faktur EKO</title>
    <style>
        body { font-family: sans-serif; background: #e0e5ec; padding: 15px; text-align: center; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        video { width: 100%; border-radius: 10px; display: none; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; }
        .btn-start { background: #007bff; }
        .btn-snap { background: #28a745; display: none; }
        .btn-csv { background: #17a2b8; }
        #status { margin: 15px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; color: #856404; min-height: 40px; }
        table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; background: white; }
        .del-btn { color: red; font-weight: bold; border: none; background: none; float: right; padding: 0 10px; }
        /* Ukrywamy canvasy techniczne */
        #canvas, #debugCanvas { display: none; }
    </style>
    <script src="tesseract.min.js"></script>
</head>
<body>

<div class="box">
    <h2>Skaner Faktur</h2>
    <p style="font-size: 12px; color: #666;">Szukam: 123/EKO/UMW/2025</p>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas> 
    <canvas id="debugCanvas"></canvas>

    <button id="startBtn" class="btn btn-start">üì∑ Uruchom kamerƒô</button>
    <button id="captureBtn" class="btn btn-snap">üì∏ Zr√≥b zdjƒôcie</button>

    <div id="status">Gotowy do pracy offline.</div>

    <table id="list">
        <thead></thead>
        <tbody id="invoiceBody"></tbody>
    </table>

    <br>
    <button id="downloadBtn" class="btn btn-csv" disabled>üíæ Pobierz CSV</button>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const debugCanvas = document.getElementById('debugCanvas');
    const statusEl = document.getElementById('status');
    let stream = null;

    // 1. URUCHOMIENIE KAMERY
    document.getElementById('startBtn').addEventListener('click', async () => {
        try {
            statusEl.innerText = "Uruchamiam kamerƒô...";
            // Pr√≥ba wymuszenia tylnej kamery
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: { exact: "environment" } } 
            }).catch(() => {
                // Je≈õli fail, bierz jakƒÖkolwiek
                return navigator.mediaDevices.getUserMedia({ video: true });
            });
            
            video.srcObject = stream;
            video.style.display = 'block';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'inline-block';
            statusEl.innerText = "Wyceluj w numer i zr√≥b zdjƒôcie";
        } catch (err) {
            statusEl.innerText = "B≈ÇƒÖd kamery: " + err.message;
        }
    });

    // 2. ROBIENIE ZDJƒòCIA
    document.getElementById('captureBtn').addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Zatrzymanie kamery
        video.srcObject.getTracks().forEach(t => t.stop());
        video.style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('captureBtn').style.display = 'none';

        runOCR();
    });

    // 3. PRZETWARZANIE OBRAZU (DLA LEPSZEJ JAKO≈öCI)
    function preprocess() {
        const ctx = canvas.getContext('2d');
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const d = imgData.data;

        // Zamiana na czarno-bia≈Çe (wysoki kontrast)
        for (let i = 0; i < d.length; i += 4) {
            const r = d[i];
            const g = d[i+1];
            const b = d[i+2];
            // Je≈õli piksel jest jasny -> zr√≥b bia≈Çy, je≈õli ciemny -> zr√≥b czarny
            const v = (0.2126*r + 0.7152*g + 0.0722*b >= 90) ? 255 : 0;
            d[i] = d[i+1] = d[i+2] = v;
        }
        
        // Zapisz wynik na ukrytym p≈Ç√≥tnie
        debugCanvas.width = canvas.width;
        debugCanvas.height = canvas.height;
        debugCanvas.getContext('2d').putImageData(imgData, 0, 0);
        return debugCanvas;
    }

    // 4. ROZPOZNAWANIE TEKSTU (OFFLINE)
    async function runOCR() {
        statusEl.innerHTML = "‚è≥ Analizujƒô zdjƒôcie...";
        
        try {
            // Skomplikowany kod, kt√≥ry m√≥wi: "U≈ºyj plik√≥w z tego samego folderu"
            const worker = await Tesseract.createWorker('eng', 1, {
                workerPath: './worker.min.js',
                corePath: './tesseract-core.wasm.js',
                langPath: './',
                gzip: true
            });

            // Pozwalamy czytaƒá tylko te znaki
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789EKOUMW/|lI',
            });

            // U≈ºywamy przerobionego (czarno-bia≈Çego) obrazu
            const processedImage = preprocess();
            const { data: { text } } = await worker.recognize(processedImage);
            
            console.log("Odczytano:", text); // Do podglƒÖdu b≈Çƒôd√≥w
            
            // Szukamy wzorca
            const cleanText = text.replace(/\s/g, '').toUpperCase();
            // Regex: Cyfry + separator + EK(0lubO) + separator + UMW + separator + 2025
            const match = cleanText.match(/(\d+)[\/1lI\|]EK[0O][\/1lI\|]UMW[\/1lI\|]2025/);

            if (match) {
                const number = match[1];
                const fullInvoice = `${number}/EKO/UMW/2025`;
                saveInvoice(fullInvoice);
                statusEl.innerHTML = `<b style="color:green">‚úÖ Dodano: ${fullInvoice}</b>`;
            } else {
                statusEl.innerHTML = `<b style="color:red">‚ùå Nie widzƒô numeru. Spr√≥buj bli≈ºej.</b><br><small>Odczytano: ${cleanText.slice(0, 20)}...</small>`;
            }

            await worker.terminate();

        } catch (e) {
            statusEl.innerText = "B≈ÇƒÖd: " + e.message;
        }
    }

    // 5. ZAPISYWANIE I TABELA
    function getInvoices() {
        return JSON.parse(localStorage.getItem('faktury_eko') || '[]');
    }

    function saveInvoice(inv) {
        const list = getInvoices();
        list.push(inv);
        localStorage.setItem('faktury_eko', JSON.stringify(list));
        renderList();
    }

    function deleteInvoice(idx) {
        const list = getInvoices();
        list.splice(idx, 1);
        localStorage.setItem('faktury_eko', JSON.stringify(list));
        renderList();
    }

    function renderList() {
        const list = getInvoices();
        const tbody = document.getElementById('invoiceBody');
        tbody.innerHTML = '';
        
        list.slice().reverse().forEach((inv, idx) => {
            // Obliczamy prawdziwy index (bo odwr√≥cili≈õmy listƒô)
            const realIdx = list.length - 1 - idx; 
            tbody.innerHTML += `<tr>
                <td>${inv}</td>
                <td><button class="del-btn" onclick="deleteInvoice(${realIdx})">X</button></td>
            </tr>`;
        });

        document.getElementById('downloadBtn').disabled = (list.length === 0);
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
        const list = getInvoices();
        const csv = "Numer Faktury\n" + list.join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "faktury.csv";
        document.body.appendChild(a);
        a.click();
    });

    // Na start
    renderList();

</script>

</body>
</html>
