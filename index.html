<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Skaner V22 – Natural</title>

<style>
* { box-sizing:border-box; margin:0; padding:0 }
body {
    background:#000; color:#fff; font-family:sans-serif;
    height:100vh; display:flex; flex-direction:column;
}
.preview {
    position:relative; height:40vh; background:#111;
}
canvas { width:100%; height:100% }
.reticle {
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:85%; height:80px;
    border:3px solid #ff3b30;
    pointer-events:none;
}
.panel {
    flex:1; padding:14px; background:#1a1a1a; overflow:auto;
}
button {
    width:100%; padding:16px; font-size:18px;
    border:none; border-radius:12px; font-weight:bold;
    margin-bottom:10px;
}
.scan { background:#ff3b30; color:#fff }
.save { background:#4cd964; color:#000 }
input {
    width:100%; padding:14px; font-size:22px;
    text-align:center; margin-bottom:10px;
}
label { font-size:12px; color:#aaa }
</style>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

<div class="preview">
    <canvas id="view"></canvas>
    <div class="reticle"></div>
</div>

<video id="video" autoplay playsinline style="display:none"></video>

<div class="panel">
    <button class="scan" id="scan">FOTO I ODCZYT</button>
    <input id="edit" placeholder="...">
    <button class="save" id="save">ZAPISZ</button>

    <label>ZOOM</label>
    <input type="range" id="zoom" min="1" max="5" step="0.1" value="2">

    <div id="status" style="margin-top:8px;color:#ff3b30;font-size:12px"></div>
    <div id="out" style="margin-top:10px;background:#fff;color:#000;border-radius:8px"></div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d');
const edit = document.getElementById('edit');
const status = document.getElementById('status');

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode:"environment", width:{ideal:1920} }
    });
    video.srcObject = stream;
    await video.play();

    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    requestAnimationFrame(draw);
}

function draw() {
    if (video.videoWidth === 0) return requestAnimationFrame(draw);

    const z = +zoom.value;
    const sw = video.videoWidth / z;
    const sh = video.videoHeight / z;
    const sx = (video.videoWidth - sw) / 2;
    const sy = (video.videoHeight - sh) / 2;

    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
    requestAnimationFrame(draw);
}

startCamera();

document.getElementById('scan').onclick = async () => {
    status.textContent = "Analiza…";

    const ocr = document.createElement('canvas');
    ocr.width = 900;
    ocr.height = 200;
    const octx = ocr.getContext('2d');

    const rx = canvas.width * 0.05;
    const ry = canvas.height * 0.5 - 40;
    const rw = canvas.width * 0.9;
    const rh = 80;

    octx.drawImage(canvas, rx, ry, rw, rh, 0, 0, ocr.width, ocr.height);

    const worker = await Tesseract.createWorker();
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');

    await worker.setParameters({
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ/',
        tessedit_pageseg_mode: 6
    });

    const { data:{ text } } = await worker.recognize(ocr);
    await worker.terminate();

    edit.value = text.replace(/[^0-9A-Z/]/g,'').trim();
    status.textContent = "Gotowe";
};

document.getElementById('save').onclick = () => {
    if (!edit.value) return;
    const d = document.createElement('div');
    d.style.padding = "10px";
    d.style.borderBottom = "1px solid #ccc";
    d.textContent = edit.value;
    out.prepend(d);
    edit.value = "";
};
</script>
</body>
</html>
