<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skaner V20 - HSV Adaptive</title>
<style>
* { box-sizing: border-box; }
body { font-family: sans-serif; background: #000; color: #fff; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
#start-overlay { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; }
.btn-start { background: #007bff; color: #fff; padding: 20px; border-radius: 50px; border: none; font-weight: bold; font-size: 18px; cursor:pointer; }
.preview-container { position: relative; width: 100%; height: 30vh; background: #111; flex-shrink: 0; }
#main-view { width: 100%; height: 100%; object-fit: contain; }
video { display: none; }
.reticle { position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); width:92%; height:55px; border:2px solid #00d2ff; box-shadow:0 0 0 1000px rgba(0,0,0,0.7); pointer-events:none; z-index:10; }
.bottom-panel { flex-grow:1; overflow-y:auto; background:#1a1a1a; padding:10px; border-top:1px solid #444; }
.btn { width:100%; padding:14px; border:none; border-radius:10px; font-weight:bold; margin-bottom:8px; font-size:15px; cursor:pointer; }
.btn-scan { background:#00d2ff; color:#000; }
.btn-save { background:#ffc107; color:#000; }
.edit-zone { background:#2a2a2a; padding:10px; border-radius:8px; margin-bottom:10px; }
input[type=text] { width:100%; padding:12px; font-size:18px; text-align:center; border-radius:5px; border:none; font-weight:bold; background:#fff; color:#000; }
.slider-group { margin-bottom:8px; display:flex; align-items:center; gap:10px; }
.slider-group label { font-size:10px; color:#00d2ff; min-width:85px; font-weight:bold; text-transform:uppercase; }
input[type=range] { flex-grow:1; height:35px; }
#status { font-size:11px; color:#00d2ff; text-align:center; margin-bottom:6px; min-height:15px; }
table { width:100%; background:#fff; color:#000; border-collapse:collapse; margin-top:10px; font-size:13px; }
td { padding:8px; border-bottom:1px solid #ccc; font-family:monospace; }
</style>
<script src="tesseract.min.js"></script>
</head>
<body>

<div id="start-overlay">
    <button id="startBtn" class="btn-start">URUCHOM SKANER V20</button>
// START VIDEO
document.getElementById('startBtn').onclick = async ()=>{
    try{
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment", width:{ideal:1920} }});
        video.srcObject = stream;
        isLive=true;
        document.getElementById('start-overlay').style.display='none';
        requestAnimationFrame(render);
    }catch(e){ alert("Błąd kamery: "+e.message);}
};

// RENDER
function render(){
    if(!isLive) return;
    const w=video.videoWidth, h=video.videoHeight;
    if(w>0){
        canvas.width=canvas.clientWidth;
        canvas.height=canvas.clientHeight;
        const z=parseFloat(zoomSlider.value);
        const sw=w/z, sh=h/z, sx=(w-sw)/2, sy=(h-sh)/2;
        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const d=imgData.data;
        const sens=parseInt(threshSlider.value);

        for(let i=0;i<d.length;i+=4){
            let r=d[i], g=d[i+1], b=d[i+2];
            let max=Math.max(r,g,b), min=Math.min(r,g,b);
            let hue, s, v=max/255, delta=max-min;
            s = max===0?0:delta/max;
            if(delta===0) hue=0;
            else if(max===r) hue=60*((g-b)/delta %6);
            else if(max===g) hue=60*((b-r)/delta+2);
            else hue=60*((r-g)/delta+4);
            if(hue<0) hue+=360;

            let isBlue=(hue>180 && hue<260 && s>0.25 && v>0.15);
            let brightness=(r+g+b)/3;
            let isDark=brightness<sens;

            d[i]=d[i+1]=d[i+2]=(isBlue||isDark)?0:255;
        }
        ctx.putImageData(imgData,0,0);
    }
    requestAnimationFrame(render);
}

// OCR
document.getElementById('scanBtn').onclick = async ()=>{
    status.innerText="⏳ ANALIZA...";
    const ocrCanvas=document.createElement('canvas');
    ocrCanvas.width=canvas.width;
    ocrCanvas.height=200;
    const ocrCtx=ocrCanvas.getContext('2d');
    ocrCtx.fillStyle="white";
    ocrCtx.fillRect(0,0,ocrCanvas.width,ocrCanvas.height);
    ocrCtx.drawImage(canvas,0,canvas.height*0.4,canvas.width,canvas.height*0.2,0,0,canvas.width,200);

    try{
        const worker = await Tesseract.createWorker({ logger:m=>console.log(m)});
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
            tessedit_char_whitelist:'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ/|',
            tessedit_pageseg_mode:7
        });
        const { data:{ text } } = await worker.recognize(ocrCanvas);
        manualEdit.value=text.replace(/[^0-9A-Z/]/g,'').trim();
        status.innerText="✅ Gotowe! Sprawdź wynik.";
        await worker.terminate();
    }catch(e){ status.innerText="Błąd OCR: "+e.message; console.error(e);}
};

// ZAPIS / CSV
document.getElementById('saveBtn').onclick = ()=>{
    const val=manualEdit.value.trim();
    if(val.length<3) return;
    let list=JSON.parse(localStorage.getItem('faktury_v20')||'[]');
    list.push(val);
    localStorage.setItem('faktury_v20',JSON.stringify(list));
    manualEdit.value="";
    status.innerText="✅ Zapisano!";
    renderList();
};

document.getElementById('clearBtn').onclick = ()=>{
    if(confirm("Wyczyścić listę?")){ localStorage.setItem('faktury_v20','[]'); renderList();}
};

function renderList(){
    const list=JSON.parse(localStorage.getItem('faktury_v20')||'[]');
    document.getElementById('results-body').innerHTML=list.slice().reverse().map(item=>`<tr><td>${item}</td></tr>`).join('');
    document.getElementById('downloadBtn').style.display=list.length>0?'block':'none';
}

document.getElementById('downloadBtn').onclick = ()=>{
    const list=JSON.parse(localStorage.getItem('faktury_v20')||'[]');
    const csv="\uFEFF"+list.join("\n");
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='faktury_eksport.csv';
    a.click();
};

renderList();
</script>
</body>
</html>
